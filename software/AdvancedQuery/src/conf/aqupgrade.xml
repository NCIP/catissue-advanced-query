<?xml version ="1.0"?>
<project name="Query DB Integration">
	<taskdef resource="net/sf/antcontrib/antcontrib.properties">
		<classpath>
			<pathelement location="./lib/ant-contrib.jar" />
		</classpath>
	</taskdef>

	<!--define require dir and Properties -->
	<property name="base.dir" value="." />
	<loadproperties srcFile="../../caTissueInstall.properties" />
	<property file="../../caTissueInstall.properties" />
	<property name="oracle.driver.string" value="oracle.jdbc.driver.OracleDriver" />
	<property name="mysql.driver.string" value="org.gjt.mm.mysql.Driver"/>
	
	<echo message="Setting Global DRIVER and URL Property" />

	<if>
		<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<property name ="final.database.driver" value="${mysql.driver.string}"/>
				<property name="final.database.url" value="jdbc:mysql://${database.host}:${database.port}/${database.name}" />
				<property name="final.csm.database.url" value="jdbc:mysql://${csm.database.host}:${csm.database.port}/${csm.database.name}" />
			</then>

		<elseif>
		<equals arg1="oracle" arg2="${database.type}" />
			<then>
				<property name ="final.database.driver" value="${oracle.driver.string}"/>
				<property name="final.database.url" value="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" />
				<property name="final.csm.database.url" value="jdbc:oracle:thin:@${csm.database.host}:${csm.database.port}:${csm.database.name}" />
			</then>
		</elseif>
	</if>
    
	<path id="liquibaseClasspath">
		<fileset dir="${deploy.temp.dir}/AdvanceQuery/lib" includes="*.jar" />
	</path>
	
	<taskdef resource="liquibasetasks.properties">
		<classpath>
			<pathelement location="${deploy.temp.dir}/AdvanceQuery/lib/liquibase.jar" />
		</classpath>
	</taskdef>
	
	<path id="liquibaserollBackClasspath">
		<fileset dir="./modules/caTissue/lib" includes="*.jar" />
	</path>
		
	<taskdef resource="liquibasetasks.properties">
		<classpath>
			<pathelement location="./modules/caTissue/lib/liquibase.jar" />
		</classpath>
	</taskdef>
	
	<target name="upgrade_to_plus_30">
		<if>
			<equals arg1="${patch_aq_plus_30}" arg2="true" /> 
			<then>
				<echo message="upgrading files for AQ plus3.0 Application ...." />
			   	<antcall target="upgrade_aq_from_nciv1.2_to_plusv3.0"/>
			</then>
		</if>
	</target>
	<target name="upgrade_aq_from_nciv1.2_to_plusv3.0">
		 
		<copy todir="${deploy.temp.dir}/${war.dir}/WEB-INF/lib" overwrite="true">
			<fileset dir="${deploy.temp.dir}/AdvanceQuery/patch/3.0/lib">
				<include name="query.jar"/>
				<include name="DAO-1.1.9.5.jar"/>
				<include name="mail.jar"/>
				<include name="velocity-dep-1.5.jar"/>
			</fileset>
		</copy>
		
		<copy todir="${deploy.temp.dir}/${war.dir}/dhtmlx_suite" overwrite="true">
			<fileset dir="${deploy.temp.dir}/AdvanceQuery/dhtmlx_suite">
				<include name="**/*"/>				 
			</fileset>
		</copy>
		
		<copy todir="${deploy.temp.dir}/${war.dir}/css" overwrite="true">
			<fileset dir="${deploy.temp.dir}/AdvanceQuery/patch/3.0/css">
				<include name="**/*"/>
			</fileset>
		</copy>
	
		<copy todir="${deploy.temp.dir}/catissuecore-properties" overwrite="true">
			<fileset dir="${deploy.temp.dir}/AdvanceQuery/patch/3.0/properties">
				<include name="**/*"/>
			</fileset>
		</copy>
		
		<copy todir="${deploy.temp.dir}/${war.dir}/jss" overwrite="true">
			<fileset dir="${deploy.temp.dir}/AdvanceQuery/patch/3.0/jss">
				<include name="**/*"/>
			</fileset>
		</copy>
		
		<copy todir="${deploy.temp.dir}/${war.dir}/pages" overwrite="true">
			<fileset dir="${deploy.temp.dir}/AdvanceQuery/patch/3.0/pages">
				<include name="**/*"/>
			</fileset>
		</copy>
		
		<copy todir="${deploy.temp.dir}/${war.dir}/WEB-INF/classes" overwrite="true">
			<fileset dir="${deploy.temp.dir}/AdvanceQuery/patch/3.0/src">
				<include name="**/*"/>
			</fileset>
		</copy>
		
		<copy todir="${deploy.temp.dir}/${war.dir}/WEB-INF/lib" overwrite="true">
			<fileset dir="${deploy.temp.dir}/AdvanceQuery/">
				<include name="AdvanceQuery.jar"/>
			</fileset>
		</copy>
		
		<antcall target="patch_aq3.0_to_commonpackage" />
		<antcall target="patch_aq3.0_to_washu-commons" />
 
		<propertyfile
		    file="${deploy.temp.dir}/${war.dir}/WEB-INF/classes/ApplicationResources.properties"
		    comment="Adding property for contact number">
		    <entry  key="login.contactnumber" default="" operation="+" value="${contact.number}"/>  
		</propertyfile>
		
		<antcall target="edit_hibernate_cfg_for_aq3.0"/>	
		 
		<antcall target="upgrade_db_for_aq_plusv3.0"/>	
		
		<copy file="${deploy.temp.dir}/AdvanceQuery/aqupgrade.xml" tofile="../../rollback_aq_upgrade.xml" overwrite="true"/>
		 
		<replace casesensitive="true" file="../../rollback_aq_upgrade.xml">
			<replacetoken><![CDATA[../../caTissueInstall.properties]]></replacetoken>  
				<replacevalue><![CDATA[./caTissueInstall.properties]]></replacevalue> 
			</replace>
				
		<replace casesensitive="false" file="../../rollback_aq_upgrade.xml">
			<replacetoken>lib/ant-contrib.jar</replacetoken>  
				<replacevalue>modules/caTissue/lib/ant-contrib.jar</replacevalue> 
		</replace>
				
	</target>	
 
	<target name="edit_hibernate_cfg_for_aq3.0">
	 	<replace casesensitive="true" 
		       	file="${deploy.temp.dir}/${war.dir}/WEB-INF/classes/hibernate.cfg.xml">
		     	<replacetoken><![CDATA[</session-factory>]]></replacetoken>  
		       	<replacevalue>
					<![CDATA[
		  				<mapping resource="QueryTag.hbm.xml"/>
		   				<mapping resource="QueryTagItem.hbm.xml"/>
					</session-factory>]]>
				</replacevalue> 
		</replace>
	</target>	
	
	<target name="patch_aq3.0_to_commonpackage">
		<unzip src="${deploy.temp.dir}/${war.dir}/WEB-INF/lib/commonpackage-1.1.8.3.6.jar" dest="${base.dir}/temp">
			<patternset>
				<include name="**/*"/>
			</patternset>
		</unzip>
			
		<copy todir="${base.dir}/temp" overwrite="true">
			<fileset dir="${deploy.temp.dir}/AdvanceQuery/patch/3.0/classes/common-package">
				<include name="**/*" />
			</fileset>
		</copy>
		
		<zip destfile="${deploy.temp.dir}/${war.dir}/WEB-INF/lib/commonpackage-1.1.8.3.6.jar" basedir="${base.dir}/temp"/>
		<delete dir="${base.dir}/temp"/>
	</target>
		
	<target name="patch_aq3.0_to_washu-commons">
		<unzip src="${deploy.temp.dir}/${war.dir}/WEB-INF/lib/washu-commons-1.1.7.jar" dest="${base.dir}/temp">
			<patternset>
				<include name="**/*"/>
			</patternset>
		</unzip>
		
		<copy todir="${base.dir}/temp" overwrite="true">
			<fileset dir="${deploy.temp.dir}/AdvanceQuery/patch/3.0/classes/washu-commons">
				<include name="**/*" />
			</fileset>
		</copy>
		 
		<zip destfile="${deploy.temp.dir}/${war.dir}/WEB-INF/lib/washu-commons-1.1.7.jar" basedir="${base.dir}/temp"/>
		<delete dir="${base.dir}/temp"/>
	</target>
	
	<target name="upgrade_db_for_aq_plusv3.0">
		
		<echo message="upgrading database with URL ${final.database.url} username=${database.username} password=${database.password}"/>		 
			<!--upgradations for colums in query and query_parameterized_query table  --> 				 
		<updateDatabase
				changeLogFile="${deploy.temp.dir}/AdvanceQuery/db/db-upgrade/liquibase_xml/query_Suite1.2_to_3.0.xml"
				driver="${final.database.driver}" url="${final.database.url}"
				username="${database.username}" password="${database.password}" 
				dropFirst="false" classpathref="liquibaseClasspath"/>		
	</target>
	
	<target name="rollback_aq_plus_db">
		<antcall target="unzip_aq_installable"/>	
		<echo message="rollbacking database with URL ${final.database.url} username=${database.username} password=${database.password}"/>		 
		<rollbackDatabase
				changeLogFile="${base.dir}/temp/AdvanceQuery/db/db-upgrade/liquibase_xml/query_Suite1.2_to_3.0.xml"
				driver="${final.database.driver}" url="${final.database.url}"
				username="${database.username}" password="${database.password}" 
				classpathref="liquibaserollBackClasspath"
				rollbackTag="aq_db_1.2"/>		
	</target>
	
	<target name="unzip_aq_installable" depends="aq_check_prerequisite" description="unzip the advance query zip">
			<unzip src="${base.dir}/modules/query/lib/AdvanceQuery_Installable.zip" dest="./temp/AdvanceQuery"
			overwrite="true" />
	</target>
	
	<target name="aq_check_prerequisite" description="Check AdvanceQueryInstallable.zip file exists or not in base directory">
		<available file="${base.dir}/modules/query/lib/AdvanceQuery_Installable.zip" property="file.exists" value="false" />
		<if>
			<not>
				<isset property="file.exists" />
			</not>
			<then>
				<echo
					message="AdvanceQuery_Installable.zip file not found. It should be in base directory to deploy Advance Query."
					level="error" />
			</then>
		</if>
	</target>
</project>
