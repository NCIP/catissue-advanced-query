<?xml version ="1.0"?>
<project name="Query Integration">
	<property name="cider.struts.config.file" value="struts-config.xml" />
	<property name="cider.hibernate.config.file" value="hibernate.cfg.xml" />
	<property name="cider.tiles.def.file" value="tiles-defs.xml" />
	<property name="datasource" value="java:/cider" />
	<property name="database.type" value="mysql" />
	<property name="oracle.dialect.string" value="org.hibernate.dialect.Oracle9Dialect" />
	<property name="mysql.dialect.string" value="org.hibernate.dialect.MySQLDialect" />
	
	<!--define require dir and Properties -->
	<taskdef resource="net/sf/antcontrib/antcontrib.properties">
		<classpath>
			<pathelement location="./lib/ant-contrib.jar" />
		</classpath>
	</taskdef>
	
	<!-- importing advance query deploy.xml for ant call --> 
		
	<!--Advance Query Related  Start-->
	<!--
		Check user selected deploy.AdvanceQuery to true and
		AdvanceQuery_Installable.zip exists
	-->
	<target name="aq_check_prerequisite">
		<!--
			Check AdvanceQueryInstallable.zip file exists or not in base
			directory.
		-->
		<echo message="aq_check_prerequisite in process........" />
		<available file="${base.dir}/AdvanceQuery_Installable.zip"
			property="file.exists" value="false" />
		<if>
			<not>
				<isset property="file.exists" />
			</not>
			<then>
				<!--
					<fail message="AdvanceQuery_Installable.zip file not found. It
					should be in base directory to deploy shippingtracking." />
				-->
				<echo
					message="AdvanceQuery_Installable.zip file not found. It should be in base directory to deploy Advance Query."
					level="error" />
			</then>
			<else>
				<echo message="Advance Query is ready to use." />
			</else>
		</if>
	</target>
	<target name="aq_integrate_app">
		<echo>deployment dir ${deploy.temp.dir}</echo>
		<echo>${deploy.temp.dir}/${war.dir}/WEB-INF/flex</echo>
		<echo message="Integrating Advance Query Application ...." />
		<unzip src="AdvanceQuery_Installable.zip" dest="${deploy.temp.dir}/AdvanceQuery"
			overwrite="true" />
		<echo message="Unzip of Advance Query Module done" />
				<!-- Inject db specific information to configuration files -->
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<echo message="${database.type}" />
				<antcall target="aq_mysql_config" />
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<echo message="${database.type}" />
					<antcall target="aq_oracle_config" />
				</then>
			</elseif>
			<else>
				<echo
					message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY"
					level="error" />
			</else>
		</if>
				<!--Copying the Advance Query jar file to deploytempCider -->
		<copy file="AdvanceQuery.jar" todir="${deploy.temp.dir}/${war.dir}/WEB-INF/lib"
			overwrite="true" />
		<echo message="Copied Advance Query Jar file" />
		<!--
			Copy *.properties, QueryHibernate.cfg.xml, *.jsp, *.css, *.images,
			advance query-struts-config.xml to respective folders
		-->
		<copy todir="${deploy.temp.dir}/${war.dir}/WEB-INF/classes"
			overwrite="true">
			<fileset dir=".">
			             <!--For time being don't copy the application resource properties -->		
						<!--<include name="ApplicationResources.properties" /> -->
				<include name="QueryHibernate.cfg.xml" />
				<include name="DynamicExtensionsHibernate.cfg.xml" />
			</fileset>
		</copy>
		<copy todir="${deploy.temp.dir}/${war.dir}/WEB-INF" overwrite="true">
			<fileset dir=".">
				<include name="advancequery-struts-config.xml" />
				<include name="AdvanceQuery-tiles-defs.xml" />
			</fileset>
		</copy>
				
				<!--Copying css files -->
		<copy todir="${deploy.temp.dir}/${war.dir}/css" overwrite="true">
			<fileset dir="css" />
		</copy>
				
				<!--Copying jss files -->
		<copy todir="${deploy.temp.dir}/${war.dir}/jss" overwrite="true">
			<fileset dir="jss" />
		</copy>
				
				<!--Copying JSP Pages -->
		<copy todir="${deploy.temp.dir}/${war.dir}/pages" overwrite="false">
			<fileset dir="pages" />
		</copy>
				
				<!--Copying Images -->
		<echo message="${base.dir}/../.." />
		<copy todir="${deploy.temp.dir}/${war.dir}/images" overwrite="false">
			<fileset dir="images" />
		</copy>
				
				<!--Copying the  flex client files for advance query-->
		<copy todir="${deploy.temp.dir}/${war.dir}/flexclient" overwrite="true">
			<fileset dir="flexclient" />
		</copy>
		<copy todir="${deploy.temp.dir}/${war.dir}/WEB-INF/flex"
			overwrite="true">
			<fileset dir="WEB-INF/flex" />
		</copy>
				<!-- 3) Inject advancequery-struts-config.xml entry in cider web.xml -->
		<replace file="${deploy.temp.dir}/AdvanceQuery/WEB-INF/web.xml">
			<replacefilter token="/WEB-INF/${cider.struts.config.file}"
				value="/WEB-INF/${cider.struts.config.file}, /WEB-INF/advancequery-struts-config.xml" />
		</replace>
				
				<!-- 4 ) Inject db-util.properties entry in cider db-util.properties -->
		<replace
			file="${deploy.temp.dir}/AdvanceQuery/WEB-INF/classes/dbutil.properties">
			<replacefilter token="${cider.hibernate.config.file}"
				value="${cider.hibernate.config.file}, QueryHibernate.cfg.xml, DynamicExtensionsHibernate.cfg.xml" />
		</replace>
		<!--
			5) Inject "/WEB-INF/AdvanceQuery-tiles-defs.xml" entry in cider
			struts-config.xml
		-->
		<replace
			file="${deploy.temp.dir}/${war.dir}/WEB-INF/${cider.struts.config.file}">
			<replacefilter token="/WEB-INF/${cider.tiles.def.file}"
				value="/WEB-INF/${cider.tiles.def.file}, /WEB-INF/AdvanceQuery-tiles-defs.xml" />
		</replace>
		<!--
			6) Concatenating the AppplicationResource.properties file from
			AdvanceQuery to Cider AppplicationResource.properties file
		-->
		<echo message="Concatenating the Application Resource Properrties file" />
		<concat
			destfile="${deploy.temp.dir}/${war.dir}/WEB-INF/classes/ApplicationResources.properties"
			append="true">
			<filelist dir="." files="ApplicationResources.properties" />
						<!--filterchain>
							<headfilter lines="155"/ -->
			<!--
				concatfilter
				append="${temp.dir}/AdvanceQuery/ApplicationResources.properties"/>
				</filterchain
			-->
		</concat>
	</target>
		<!-- Modify Advance Query configuration For MySQL -->
	<target name="aq_mysql_config">
		<replace file="${deploy.temp.dir}/AdvanceQuery/QueryHibernate.cfg.xml">
			<replacefilter token="${mysql.dialect.string}" value="${mysql.dialect.string}" />
			<replacefilter token="@@dataSource@@" value="${datasource}" />
		</replace>
				
				<!-- Modifying the data source for DynamicExtensionsHibernate.cfg.xml-->
		<replace
			file="${deploy.temp.dir}/AdvanceQuery/DynamicExtensionsHibernate.cfg.xml">
			<replacefilter token="${mysql.dialect.string}" value="${mysql.dialect.string}" />
			<replacefilter token="@@dataSource@@" value="${datasource}" />
		</replace>
	</target>
				
			<!-- Modify Advance Query configuration For ORACLE -->
	<target name="aq_oracle_config">
		<replace file="QueryHibernate.cfg.xml">
			<replacefilter token="${mysql.dialect.string}" value="${oracle.dialect.string}" />
			<replacefilter token="@@dataSource@@" value="${datasource}" />
		</replace>
				
					<!-- Modifying the data source for DynamicExtensionsHibernate.cfg.xml-->
		<replace file="DynamicExtensionsHibernate.cfg.xml">
			<replacefilter token="@@dataSource@@" value="${datasource}" />
		</replace>
	</target>
	<!--
		target name="aq_integrate_app"> <ant dir="." inheritAll="false"
		antfile="deploy.xml" target="aq_integrate_app" /> </target
	-->
	<target name="advquery_integrate_app">
		<antcall target="aq_integrate_app">
			<param name="deploy.temp.dir" value="deploytempCider" />
			<param name="war.dir" value="cider" />
		</antcall>
	</target>
	<target name="aq_deploy_db_mysql">
	<!-- Oracle mysql Creation -->
		<ant dir="." inheritAll="false" antfile="deploy.xml" target="aq_deploy_db_mysql" />
	</target>
	<target name="aq_deploy_db_oracle">
	<!-- Oracle Database Creation -->
		<ant dir="." inheritAll="false" antfile="deploy.xml" target="aq_deploy_db_oracle" />
	</target>
	<target name="aq_deploy_db">
	<!-- Deploying Advance Query db -->
		<ant dir="." inheritAll="false" antfile="deploy.xml" target="aq_deploy_db" />
	</target>
	
	<!--Advance Query Related  End -->
</project>