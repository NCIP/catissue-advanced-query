<?xml version ="1.0"?>
<project name="Query Integration">
	
	<!--define require dir and Properties -->
	<property name="cider.struts.config.file" value="struts-config.xml" />
	<property name="cider.hibernate.config.file" value="hibernate.cfg.xml" />
	<property name="cider.tiles.def.file" value="tiles-defs.xml" />
	
	<!--Advance Query Related  Start-->
	<!--
		Check user selected deploy.AdvanceQuery to true and
		AdvanceQuery_Installable.zip exists
	-->
	<target name="aq_check_prerequisite">
		<!--
			Check AdvanceQueryInstallable.zip file exists or not in base
			directory.
		-->
		<echo message="aq_check_prerequisite in process........" />
		<available file="${base.dir}/AdvanceQuery_Installable.zip"
			property="file.exists" value="false" />
		<if>
			<not>
				<isset property="file.exists" />
			</not>
			<then>
				<!--
					<fail message="AdvanceQuery_Installable.zip file not found. It
					should be in base directory to deploy shippingtracking." />
				-->
				<echo
					message="AdvanceQuery_Installable.zip file not found. It should be in base directory to deploy Advance Query."
					level="error" />
			</then>
			<else>
				<echo message="Advance Query is ready to use." />
			</else>
		</if>
	</target>
	
	<target name="aq_integrate_app">
		<echo message="Integrating Advance Query Application ...." />
		<echo message="Unzip of Advance Query Module done" />
		<!-- Inject db specific information to configuration files -->
		<echo message="datatype : ${database.type}" />
		<if>			
			<equals arg1="mysql" arg2="${database.type}" />
			<then>				
				<antcall target="aq_mysql_config" />
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<echo message="${database.type}" />
					<antcall target="aq_oracle_config" />
				</then>
			</elseif>
			<elseif>
				<equals arg1="db2" arg2="${database.type}" />
					<then>
						<echo message="${database.type}" />
						<antcall target="aq_db2_config" />
					</then>
			</elseif>
			<else>
				<echo
					message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY"
					level="error" />
			</else>
		</if>
		<!--Copying the Query property file to cider classes -->
		<copy file="query.properties" todir="${deploy.temp.dir}/${war.dir}/WEB-INF/classes/"
					overwrite="true" />
		
		
		<!--Copying the vocab.properties file for VI-->
		<copy file="query-properties/vocab.properties" todir="${deploy.temp.dir}/cider-properties" overwrite="true"/>
		<copy file="query-properties/configuredVocabs.properties" todir="${deploy.temp.dir}/cider-properties" overwrite="true"/>
		
		<!--Copying the Advance Query jar file to deploytempCider -->
		
		<copy file="AdvanceQuery.jar" todir="${deploy.temp.dir}/${war.dir}/WEB-INF/lib"
			overwrite="true" />
		<echo message="Copied Advance Query Jar file" />
		
		<!--Copying VI jars -->
		<echo message="Copying VI jars..."/>
		<copy todir="${deploy.temp.dir}/${war.dir}/WEB-INF/lib" overwrite="true">
		   <fileset dir="${deploy.temp.dir}/AdvanceQuery/vi_jars">
				<include name="*.*" />
		  </fileset>
	   </copy>
		
		<!-- Copying the LexBig Data to JBOSS DATA
		<echo message="Copying LexBigData to JBOSS DATA"/>
		<copy todir="${jboss.server.url}/data/LexBIGData" overwrite="false">
			<fileset dir="LexBIGData" />
		</copy>
		-->
		
		
		<!--
			Copy *.properties, QueryHibernate.cfg.xml, *.jsp, *.css, *.images,
			advance query-struts-config.xml to respective folders
		-->
		<copy todir="${deploy.temp.dir}/${war.dir}/WEB-INF/classes"
			overwrite="true">
			<fileset dir=".">
				<include name="QueryHibernate.cfg.xml" />
				<include name="DynamicExtensionsHibernate.cfg.xml" />
			</fileset>
		</copy>
		<antcall target="modify_query_tiles-def"/>
		
		<copy todir="${deploy.temp.dir}/${war.dir}/WEB-INF" overwrite="true">
			<fileset dir=".">
				<include name="advancequery-struts-config.xml" />
				<include name="AdvanceQuery-tiles-defs.xml" />
			</fileset>
		</copy>

		<!--Copying css files -->
		<copy todir="${deploy.temp.dir}/${war.dir}/css" overwrite="true">
			<fileset dir="css" />
		</copy>

		<!--Copying jss files -->
		<copy todir="${deploy.temp.dir}/${war.dir}/jss" overwrite="true">
			<fileset dir="jss" />
		</copy>

		<!--Copying JSP Pages -->
		<copy todir="${deploy.temp.dir}/${war.dir}/pages" overwrite="false">
			<fileset dir="pages" />
		</copy>

		<!--Copying Images -->		
		<copy todir="${deploy.temp.dir}/${war.dir}/images" overwrite="false">
			<fileset dir="images" />
		</copy>

		<!--Copying the  flex client files for advance query-->
		<copy todir="${deploy.temp.dir}/${war.dir}/flexclient" overwrite="true">
			<fileset dir="flexclient" />
		</copy>
		<copy todir="${deploy.temp.dir}/${war.dir}/WEB-INF/flex"
			overwrite="true">
			<fileset dir="flex" />
		</copy>
		<!-- 3) Inject advancequery-struts-config.xml entry in cider web.xml -->
		<replace file="${deploy.temp.dir}/${war.dir}/WEB-INF/web.xml">
			<replacefilter token="/WEB-INF/${cider.struts.config.file}"
				value="/WEB-INF/${cider.struts.config.file}, /WEB-INF/advancequery-struts-config.xml" />
			<replacetoken>&lt;/web-app&gt;</replacetoken>
			    	  <replacevalue><![CDATA[	 <filter>
	  <filter-name>loginFilter</filter-name>
	  <filter-class> 
	    edu.wustl.query.util.filter.QueryRequestFilter  
	  </filter-class>
	</filter>
	<filter-mapping>
	  <filter-name>loginFilter</filter-name>
	  <url-pattern>*.do</url-pattern>
	</filter-mapping>
</web-app>
					]]></replacevalue>
		</replace>

		<!-- 4 ) Inject db-util.properties entry in cider db-util.properties -->
		<replace
			file="${deploy.temp.dir}/${war.dir}/WEB-INF/classes/dbutil.properties">
			<replacefilter token="${cider.hibernate.config.file}"
				value="${cider.hibernate.config.file}, QueryHibernate.cfg.xml, DynamicExtensionsHibernate.cfg.xml" />
		</replace>
		<!--
			5) Inject "/WEB-INF/AdvanceQuery-tiles-defs.xml" entry in cider
			struts-config.xml
		-->
		<replace
			file="${deploy.temp.dir}/${war.dir}/WEB-INF/${cider.struts.config.file}">
			<replacefilter token="/WEB-INF/${cider.tiles.def.file}"
				value="/WEB-INF/${cider.tiles.def.file}, /WEB-INF/AdvanceQuery-tiles-defs.xml" />
		</replace>
		<!--
			6) Concatenating the AppplicationResource.properties file from
			AdvanceQuery to Cider AppplicationResource.properties file
		-->
		<echo message="Concatenating the Application Resource Properrties file" />
		<concat
			destfile="${deploy.temp.dir}/${war.dir}/WEB-INF/classes/ApplicationResources.properties"
			append="true">
			<fileset file="ApplicationResources.properties" />			
		</concat>
		
		<echo message="Advance Query is ready to use." />
	</target>
	<!-- Modify Advance Query configuration For MySQL -->
	<target name="aq_mysql_config">
		<replace file="QueryHibernate.cfg.xml">
			<replacefilter token="${mysql.dialect.string}" value="${mysql.dialect.string}" />
			<replacefilter token="@@dataSource@@" value="${datasource}" />
		</replace>

		<!-- Modifying the data source for DynamicExtensionsHibernate.cfg.xml-->
		<echo message="${datasource}" />
		<echo message="${mysql.dialect.string}"/>
		
		<replace file="DynamicExtensionsHibernate.cfg.xml">
			<replacefilter token="${mysql.dialect.string}" value="${mysql.dialect.string}" />
			<replacefilter token="@@dataSource@@" value="${datasource}" />
		</replace>
	</target>

	<!-- Modify Advance Query configuration For ORACLE -->
	<target name="aq_oracle_config">
		<replace file="QueryHibernate.cfg.xml">
			<replacefilter token="${mysql.dialect.string}" value="${oracle.dialect.string}" />
			<replacefilter token="@@dataSource@@" value="${datasource}" />
		</replace>

		<!-- Modifying the data source for DynamicExtensionsHibernate.cfg.xml-->
		<replace file="DynamicExtensionsHibernate.cfg.xml">
			<replacefilter token="${mysql.dialect.string}" value="${oracle.dialect.string}" />
			<replacefilter token="@@dataSource@@" value="${datasource}" />
		</replace>
	</target>
					
	<!-- Modify Advance Query configuration For ORACLE -->
	<target name="aq_db2_config">
		<replace file="QueryHibernate.cfg.xml">
			<replacefilter token="${mysql.dialect.string}" value="${db2.dialect.string}" />
			<replacefilter token="@@dataSource@@" value="${datasource}" />
		</replace>

		<!-- Modifying the data source for DynamicExtensionsHibernate.cfg.xml-->
		<replace file="DynamicExtensionsHibernate.cfg.xml">
			<replacefilter token="${mysql.dialect.string}" value="${db2.dialect.string}" />
			<replacefilter token="@@dataSource@@" value="${datasource}" />
		</replace>
	</target>

	<target name="aq_deploy_db">
		<!-- Deploying Advance Query db -->
		<ant dir="." inheritAll="false" antfile="deploy.xml" target="deploy_db">
			<property name="database.type" value="${database.type}" />
			<property name="database.host" value="${database.host}" />
			<property name="database.port" value="${database.port}" />
			<property name="database.name" value="${database.name}" />
			<property name="database.username" value="${database.username}" />
			<property name="database.password" value="${database.password}" />
			<property name="database.schema" value="${database.schema}" />
		</ant>
	</target>
	
	<target name = "add_curated_Path">
		<echo message="In Add curated path in Query Integraion Xml"/>
		<ant dir="." inheritAll="false" antfile="deploy.xml" target="add_curated_Path">
			<property name="jboss.server.url" value="${jboss.server.url}"/>
 			<property name="database.type" value="${database.type}" />
			<property name="database.host" value="${database.host}" />
			<property name="database.port" value="${database.port}" />
			<property name="database.name" value="${database.name}" />
			<property name="database.username" value="${database.username}" />			
			<property name="database.password" value="${database.password}" />
			<property name="database.schema" value="${database.schema}" />
		</ant>
	</target>
	
	<target name="modify_query_tiles-def">
			<!--Replacing tokens in tiles-def -->
			<copy file= "${deploy.temp.dir}/cider/mainTiles.properties"  todir="${deploy.temp.dir}/AdvanceQuery" overwrite="true" />
				<property file="${deploy.temp.dir}/AdvanceQuery/mainTiles.properties"></property>
						<replace dir="${deploy.temp.dir}/AdvanceQuery/" propertyfile="mainTiles.properties"> 
									<include name ="AdvanceQuery-tiles-defs.xml"/>
									<replacefilter token="@@tilesTitle@@" value="${tilesTitle}"/>
									<replacefilter token="@@tilesHeader@@" value="${tilesHeader}"/>
									<replacefilter token="@@tilesAppHeader@@" value="${tilesAppHeader}"/>
									<replacefilter token="@@tilesMainMenu@@" value="${tilesMainMenu}"/>
									<replacefilter token="@@tilesQuickLaunch@@" value="${tilesQuickLaunch}"/>
									<replacefilter token="@@tilesContent@@" value="${tilesContent}"/>
									<replacefilter token="@@tilesFooter@@" value="${tilesFooter}"/>
						</replace>
			<echo message="${tilesTitle}"/>
				</target>

	<!--Advance Query Related  End -->
</project>